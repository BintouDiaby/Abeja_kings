{% extends 'core/base.html' %}
{% block title %}Historique Paiements Personnel{% endblock %}
{% block content %}
<div class="content-area">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px">
    <h2 style="margin:0">Paiement du personnel</h2>
    <div>
      <a href="{% url 'core:personnel' %}" onclick="history.back(); return false;" class="btn-ghost" style="padding:8px 10px;border-radius:8px;background:#f3f4f6;color:#0f172a;border:1px solid #e2e8f0;text-decoration:none">‚Üê Retour</a>
    </div>
  </div>
  <form method="get" style="display:flex;gap:12px;align-items:end;margin-bottom:14px">
    <div>
      <label>Mois</label>
      <input type="month" name="month" value="{{ filters.month }}">
    </div>
    <div>
      <label>Chantier</label>
      <select name="chantier">
        <option value="">Tous</option>
        {% for c in chantiers %}
        <option value="{{ c.id }}" {% if filters.chantier == c.id|stringformat:"s" %}selected{% endif %}>{{ c.nom }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <button class="btn btn-primary" type="submit">Filtrer</button>
      <a class="btn btn-outline" href="?{% if filters.month %}month={{ filters.month }}&{% endif %}{% if filters.chantier %}chantier={{ filters.chantier }}&{% endif %}export=csv">Export CSV</a>
    </div>
  </form>

  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>Employ√©</th>
          <th>Poste</th>
          <th>Chantier</th>
          <th>Net (FCFA)</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.personnel.user.get_full_name }}</td>
          <td>{{ r.personnel.get_role_display }}</td>
          <td>{{ r.personnel.chantier_actuel.nom|default:"-" }}</td>
          <td>{{ r.expected|floatformat:0 }}</td>
          <td>{% if r.status == 'Pay√©' %}üü¢ Pay√©{% else %}‚è≥ En attente{% endif %}</td>
          <td>
            <a class="btn btn-outline" href="{% url 'core:personnel_payments' personnel_id=r.personnel.pk %}?periode={{ filters.month }}">Ouvrir / Payer</a>
            {% if r.status != 'Pay√©' %}
            <form method="post" action="{% url 'core:personnel_mark_paid' personnel_id=r.personnel.pk %}" style="display:inline;margin-left:8px" onsubmit="return confirm('Confirmer le paiement de {{ r.expected|floatformat:0 }} FCFA √† {{ r.personnel.user.get_full_name }} ?')">
              {% csrf_token %}
              <input type="hidden" name="periode" value="{{ filters.month }}">
              <input type="hidden" name="chantier" value="{{ filters.chantier }}">
              <button class="btn btn-primary" type="submit">Marquer comme pay√©</button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="6">Aucun employ√© trouv√© pour ce filtre</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
