{% extends "core/base.html" %}
{% load static %}

{% block extrastyle %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Styles spécifiques à la page Rapports, intégrés dans le layout principal */
:root{--primary:#4361ee;--primary-light:#4895ef;--secondary:#3f37c9;--success:#4cc9f0;--dark:#2b2d42;--light:#f8f9fa;--gray:#adb5bd;--gray-light:#e9ecef;--white:#ffffff;--shadow:0 4px 20px rgba(0,0,0,0.08);--radius:12px;--transition:all .3s ease}
.rapports-page .page-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:2.0rem;border-radius:12px;margin-bottom:1.5rem;box-shadow:var(--shadow)}
.rapports-page .stats-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;margin-bottom:1.5rem}
.rapports-page .stat-card{background:var(--white);padding:1rem;border-radius:8px;box-shadow:var(--shadow)}
.rapports-page .stat-value{font-size:1.6rem;color:var(--primary);font-weight:700}
.rapports-page .rapport-item{background:var(--white);border-radius:10px;padding:1rem;margin-bottom:1rem;box-shadow:var(--shadow);border-left:4px solid var(--primary)}
.rapports-page .rapport-title strong{font-size:1.05rem}
.rapports-page .rapport-description{background:rgba(67,97,238,0.05);padding:.8rem;border-radius:6px}
.rapports-page .filter-section{background:var(--white);padding:1rem;border-radius:8px;box-shadow:var(--shadow);display:flex;gap:1rem;flex-wrap:wrap}
.rapports-page .btn{border-radius:999px;padding:.6rem 1rem}
.rapports-page .form-control{padding:.6rem;border:1px solid var(--gray-light);border-radius:6px}
</style>
{% endblock %}

{% block title %}Rapports Journaliers{% endblock %}

{% block content %}
<div class="dashboard-container rapports-page">
  <div class="page-header">
    <h2><i class="fa-solid fa-chart-bar" aria-hidden="true"></i> Rapports journaliers</h2>
    <p>Rédigez votre rapport de chantier pour la journée. Les chefs et administrateurs voient tous les rapports.</p>
  </div>

  <div class="stats-cards">
    <div class="stat-card">
      <div class="stat-value" id="rapports-count">{{ rapports_count|default:0 }}</div>
      <div class="stat-label">Rapports (journalier / hebdomadaire)</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ rapports_pending|default:0 }}</div>
      <div class="stat-label">Rapports en attente</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ chantiers_actifs|default:0 }}</div>
      <div class="stat-label">Chantiers actifs</div>
    </div>
  </div>

  <div class="rapport-actions">
    <a href="#form" class="btn btn-primary" onclick="document.getElementById('form-new-rapport').scrollIntoView({behavior:'smooth'});return false;">
      <i class="fa-solid fa-plus" aria-hidden="true"></i> Nouveau rapport
    </a>
    <div class="filter-section">
      <div class="filter-group">
        <label for="filter-date">Filtrer par date</label>
        <input type="date" id="filter-date" class="form-control form-control--small">
      </div>
      <div class="filter-group">
        <label for="filter-chantier">Filtrer par chantier</label>
        <select id="filter-chantier" class="form-control form-control--small">
          <option value="">Tous les chantiers</option>
          {% for c in chantiers_list %}
            <option value="{{ c.id }}">{{ c.nom }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div id="form-new-rapport" class="rapport-form" style="margin-top:1rem">
    <form id="form-rapport" method="post" action="{% url 'core:rapport_new' %}">
      {% csrf_token %}
      <div class="form-row">
        <label for="titre">Titre</label>
        <input type="text" name="titre" id="titre" class="form-control" required>
      </div>
      <div class="form-row">
        <label for="chantier">Chantier (optionnel)</label>
        <input type="text" id="chantier-filter" class="form-control" placeholder="Filtrer les chantiers..." style="margin-bottom:8px">
        <select name="chantier" id="chantier" class="form-control">
          <option value="">-- Aucun --</option>
          {% for c in chantiers_list %}
            <option value="{{ c.id }}">{{ c.nom }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-row">
        <label for="nom_remplisseur">Votre nom (affiché dans le rapport)</label>
        <input type="text" name="nom_remplisseur" id="nom_remplisseur" class="form-control" value="{{ request.user.get_full_name|default:request.user.username }}">
      </div>
      <div class="form-row">
        <label for="chef_concerne">Chef de chantier concerné (optionnel)</label>
        <select name="chef_concerne" id="chef_concerne" class="form-control">
          <option value="">-- Aucun --</option>
          {% for c in chantiers_list %}
            {% if c.chef_chantier %}
              <option value="{{ c.chef_chantier.get_full_name|default:c.chef_chantier.username }}">{{ c.chef_chantier.get_full_name|default:c.chef_chantier.username }} — {{ c.nom }}</option>
            {% elif c.chef_chantier_employee and c.chef_chantier_employee.user %}
              <option value="{{ c.chef_chantier_employee.user.get_full_name|default:c.chef_chantier_employee.user.username }}">{{ c.chef_chantier_employee.user.get_full_name|default:c.chef_chantier_employee.user.username }} — {{ c.nom }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      <div class="form-row">
        <label for="contenu">Détails</label>
        <textarea name="contenu" id="contenu" class="form-control" rows="6" required></textarea>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-success"><i class="fa-solid fa-save" aria-hidden="true"></i> Enregistrer</button>
      </div>
    </form>
  </div>

  <hr class="separator">

  <div class="rapports-list">
    <h3><i class="fa-solid fa-history" aria-hidden="true"></i> Historique des rapports</h3>
    {% if rapports %}
      <ul class="list-rapports">
        {% for rapport in rapports %}
          <li class="rapport-item">
            <div class="rapport-header">
              <div class="rapport-title">
                <strong>{{ rapport.titre }}</strong>
                {% if rapport.chantier %}<span class="chantier-badge">{{ rapport.chantier.nom }}</span>{% endif %}
              </div>
              <span class="rapport-date"><i class="fa-regular fa-calendar" aria-hidden="true"></i> {{ rapport.created_at|date:'d/m/Y H:i' }}</span>
            </div>
            {% if rapport.description %}<p class="rapport-description">{{ rapport.description }}</p>{% endif %}
            <div class="rapport-content">{{ rapport.contenu|linebreaksbr }}</div>
            <div class="rapport-meta">
              <span class="rapport-author"><div class="author-avatar">{{ rapport.auteur.get_full_name|default:rapport.auteur.username|first|upper }}</div> {{ rapport.auteur.get_full_name|default:rapport.auteur.username }}</span>
              <div style="display:flex;gap:1rem;align-items:center">
                <span><i class="fa-regular fa-eye" aria-hidden="true"></i> 0 vues</span>
                {% if request.user.userprofile.role == 'admin' %}
                  <div style="display:flex;gap:.5rem">
                    <button onclick="editRapport({{ rapport.id }})" class="btn-icon btn-edit" title="Modifier"><i class="fa-solid fa-edit" aria-hidden="true"></i></button>
                    <form method="post" action="{% url 'core:rapport_delete' rapport.id %}" style="display:inline" onsubmit="return confirm('Supprimer ?');">{% csrf_token %}<button type="submit" class="btn-icon btn-delete"><i class="fa-solid fa-trash" aria-hidden="true"></i></button></form>
                  </div>
                {% endif %}
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="empty-state"><i class="fa-solid fa-chart-bar" aria-hidden="true"></i><p>Aucun rapport trouvé.</p></div>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// AJAX form submission for new rapports and UI refresh
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}

async function refreshRapportsUI() {
  try {
    const resp = await fetch('/api/rapports/', {credentials: 'same-origin'});
    if (!resp.ok) return;
    const data = await resp.json();
    const rapports = data.rapports || [];

    // update counter
    const countEl = document.getElementById('rapports-count');
    if (countEl) countEl.textContent = rapports.length;

    // rebuild list
    const listContainer = document.querySelector('.rapports-list');
    if (!listContainer) return;
    const ul = listContainer.querySelector('.list-rapports');
    if (!ul) {
      // create list
      const newUl = document.createElement('ul');
      newUl.className = 'list-rapports';
      listContainer.appendChild(newUl);
    }
    const targetUl = listContainer.querySelector('.list-rapports');
    targetUl.innerHTML = '';
    rapports.forEach(r => {
      const li = document.createElement('li');
      li.className = 'rapport-item';
      const date = r.created_at ? new Date(r.created_at).toLocaleString('fr-FR') : (r.date ? new Date(r.date).toLocaleDateString('fr-FR') : '');
      const authorName = (r.auteur && r.auteur.full_name) ? r.auteur.full_name : (r.auteur && typeof r.auteur === 'string' ? r.auteur : '');
      const chantierName = (r.chantier && r.chantier.nom) ? r.chantier.nom : (r.chantier && typeof r.chantier === 'string' ? r.chantier : '');
      li.innerHTML = `
        <div class="rapport-header">
          <div class="rapport-title"><strong>${escapeHtml(r.titre)}</strong>${chantierName ? ' <span class="chantier-badge">'+escapeHtml(chantierName)+'</span>' : ''}</div>
          <span class="rapport-date"><i class="far fa-calendar"></i> ${date}</span>
        </div>
        <div class="rapport-content">${escapeHtml(r.contenu || '').replace(/\n/g,'<br>')}</div>
        <div class="rapport-meta"><span class="rapport-author"><div class="author-avatar">${authorName ? escapeHtml(authorName.charAt(0)) : ''}</div> ${escapeHtml(authorName)}</span></div>
      `;
      targetUl.appendChild(li);
    });

  } catch (e) {
    console.error('refreshRapportsUI error', e);
  }
}

function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>\"'`]/g, function(s) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'})[s]; });
}

document.addEventListener('DOMContentLoaded', function(){
  const form = document.getElementById('form-rapport');
  if (!form) return;
  // chantier filter
  const filterInput = document.getElementById('chantier-filter');
  if (filterInput) {
    filterInput.addEventListener('input', function(){
      const q = this.value.toLowerCase();
      document.querySelectorAll('#chantier option').forEach(opt => {
        if (!opt.value) return; // keep the -- Aucun -- option
        const text = opt.textContent.toLowerCase();
        // use the 'hidden' attribute which works consistently for <option>
        opt.hidden = q ? !text.includes(q) : false;
      });
    });
  }

  // Filter displayed rapports by chantier (top select)
  const topChantierFilter = document.getElementById('filter-chantier');
  if (topChantierFilter) {
    topChantierFilter.addEventListener('change', function(){
      const val = this.value; // empty means all
      document.querySelectorAll('.list-rapports .rapport-item').forEach(li => {
        const badge = li.querySelector('.chantier-badge');
        const chantierText = badge ? badge.textContent.trim() : '';
        if (!val || val === '') {
          li.style.display = '';
        } else {
          // compare by id or by name; top select uses id values, but the badge shows name.
          // Try matching by name fallback
          const selectedText = this.options[this.selectedIndex].textContent || '';
          const nameOnly = selectedText.split('—')[0].trim();
          li.style.display = chantierText && chantierText.indexOf(nameOnly) !== -1 ? '' : 'none';
        }
      });
    });
  }

  // Filter displayed rapports by date (top date input)
  const topDateFilter = document.getElementById('filter-date');
  if (topDateFilter) {
    topDateFilter.addEventListener('change', function(){
      const v = this.value; // yyyy-mm-dd
      if (!v) {
        document.querySelectorAll('.list-rapports .rapport-item').forEach(li => li.style.display = '');
        return;
      }
      const parts = v.split('-');
      if (parts.length !== 3) return;
      const ddmmyyyy = `${parts[2]}/${parts[1]}/${parts[0]}`;
      document.querySelectorAll('.list-rapports .rapport-item').forEach(li => {
        const dateEl = li.querySelector('.rapport-date');
        const txt = dateEl ? dateEl.textContent : '';
        li.style.display = txt.indexOf(ddmmyyyy) !== -1 ? '' : 'none';
      });
    });
  }
  form.addEventListener('submit', async function(e){
    e.preventDefault();
    const btn = form.querySelector('button[type="submit"]');
    if (btn) btn.disabled = true;
    const url = form.action;
    const formData = new FormData(form);
    try {
      const resp = await fetch(url, {
        method: 'POST',
        body: formData,
        credentials: 'same-origin',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const data = await resp.json();
      if (data && data.ok) {
        // clear form
        form.reset();
        // refresh UI
        await refreshRapportsUI();
        // scroll to list
        const list = document.querySelector('.rapports-list');
        if (list) list.scrollIntoView({behavior:'smooth'});
      } else {
        console.warn('create rapport response', data);
        // fallback: full reload
        window.location.reload();
      }
    } catch (err) {
      console.error('Erreur en soumettant le rapport', err);
      window.location.reload();
    } finally {
      if (btn) btn.disabled = false;
    }
  });
});
</script>
{% endblock %}